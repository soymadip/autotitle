[tools]
go = "1.26"
golangci-lint = "latest"
uv = "latest"
"pipx:commitizen" = "latest"

[shell_alias]
cz = "cz --config {{env.CZ_CONFIG}}"

[env]
_.path = "./bin"
_.source = { path = "./scripts/version.sh", tools = true }

CZ_CONFIG = "src/cz/cz.yaml"
BINARY_NAME = "autotitle"

BIN_DIR = "bin"
DIST_DIR = "dist"

# Tasks
[tasks.setup]
description = "Setup development environment"
run = "mise install --yes && go mod download"

[tasks.build]
description = "Build development binary"
sources = ["**/*.go", "go.mod", "go.sum"]
outputs = ["{{env.BIN_DIR}}/{{env.BINARY_NAME}}"]
run = "go build -ldflags \"$LDFLAGS_BASE\" -o {{env.BIN_DIR}}/{{env.BINARY_NAME}} ./cmd/autotitle"

[tasks.release]
description = "Build release binary (stripped, optimized)"
run = """
    mise install go
    go build -trimpath -ldflags \"$LDFLAGS_RELEASE\" -o {{env.BIN_DIR}}/{{env.BINARY_NAME}} ./cmd/autotitle
"""

[tasks.release-all]
description = "Build optimized binaries for Linux, macOS (amd64/arm64) & Windows (amd64)"
run = """
    mise install go
    mkdir -p {{env.BIN_DIR}}
    # Linux
    GOOS=linux GOARCH=amd64 go build -trimpath -ldflags "$LDFLAGS_RELEASE" -o {{env.BIN_DIR}}/{{env.BINARY_NAME}}-linux-amd64 ./cmd/autotitle
    GOOS=linux GOARCH=arm64 go build -trimpath -ldflags "$LDFLAGS_RELEASE" -o {{env.BIN_DIR}}/{{env.BINARY_NAME}}-linux-arm64 ./cmd/autotitle
    # macOS
    GOOS=darwin GOARCH=amd64 go build -trimpath -ldflags "$LDFLAGS_RELEASE" -o {{env.BIN_DIR}}/{{env.BINARY_NAME}}-darwin-amd64 ./cmd/autotitle
    GOOS=darwin GOARCH=arm64 go build -trimpath -ldflags "$LDFLAGS_RELEASE" -o {{env.BIN_DIR}}/{{env.BINARY_NAME}}-darwin-arm64 ./cmd/autotitle
    # Windows
    GOOS=windows GOARCH=amd64 go build -trimpath -ldflags "$LDFLAGS_RELEASE" -o {{env.BIN_DIR}}/{{env.BINARY_NAME}}-windows-amd64.exe ./cmd/autotitle
"""

[tasks.install]
description = "Install optimized binary to GOPATH/bin"
run = """
    mise install go
    go install -ldflags \"$LDFLAGS_RELEASE\" ./cmd/autotitle
"""

[tasks.clean]
description = "Clean build artifacts"
run = "rm -rf {{env.BIN_DIR}} && echo \"Cleaning...\""

[tasks.test]
description = "Run tests"
run = "go test ./..."

[tasks.fmt]
description = "Format code"
run = "go fmt ./..."

[tasks.package]
description = "Package binaries for release"
depends = ["release-all"]
run = """
    mkdir -p {{env.DIST_DIR}}
    rm -rf {{env.DIST_DIR}}/*
    cp {{env.BIN_DIR}}/* {{env.DIST_DIR}}/
    cd {{env.DIST_DIR}} && sha256sum * > checksums.txt
"""

[tasks.lint]
description = "Run linter"
run = "golangci-lint run ./..."

[tasks.get-changelog]
description = "Get changelog"
run = "cz --config $CZ_CONFIG changelog \"{{ env.LATEST_TAG}}..{{env.LATEST_TAG}}\" --dry-run | sed -n '/^###/,$p'"
