name: Update Distribution Packages
run-name: "Update Distribution Packages: (${{ github.event_name == 'workflow_run' && 'Release' || 'Manual Fix' }})"

on:
  workflow_run:
    workflows: ["Make GitHub Release"]
    types:
      - completed

  push:
    branches: [main]
    paths:
      - "PKGBUILD"
      - ".github/workflows/update-packages.yml"

  workflow_dispatch:
    inputs:
      version:
        description: "Version to publish (e.g., 1.4.0)"
        required: false
        type: string

concurrency:
  group: update-dist-packages
  cancel-in-progress: true

permissions:
  contents: write
  pull-requests: write

jobs:
  get-info:
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success') ||
      (github.event_name == 'push' && !startsWith(github.event.head_commit.message, 'chore(release):')) ||
      (github.event_name == 'workflow_dispatch')

    outputs:
      version: ${{ steps.resolve-meta.outputs.version }}
      is_manual: ${{ steps.resolve-meta.outputs.is_manual }}
      pkgname: ${{ steps.resolve-meta.outputs.pkgname }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Resolve metadata
        id: resolve-meta
        run: |
          # Get package name from repository name (lowercase)
          PKGNAME=$(echo "${{ github.event.repository.name }}" | tr '[:upper:]' '[:lower:]')

          # Workflow run
          if [ "${{ github.event_name }}" == "workflow_run" ]; then
            RAW_TAG="${{ github.event.workflow_run.head_branch }}"
            if [[ "$RAW_TAG" == "main" || -z "$RAW_TAG" ]]; then
              RAW_TAG=$(git describe --tags --abbrev=0)
            fi

            VERSION="${RAW_TAG#v}"
            IS_MANUAL="false"

          # Workflow dispatch with version input 
          elif [ "${{ github.event_name }}" == "workflow_dispatch" ] && [ -n "${{ github.event.inputs.version }}" ]; then
            VERSION="${{ github.event.inputs.version }}"
            IS_MANUAL="true"

          # Push or manual without version input: Read from file
          else
            VERSION=$(sed -n 's/^pkgver=//p' PKGBUILD | tr -d '"' | tr -d "'")
            IS_MANUAL="true"
          fi

          echo "Package Name:     $PKGNAME"
          echo "Detected Version: $VERSION"
          echo "Is Manual Update: $IS_MANUAL"

          # Output core variables
          echo "pkgname=$PKGNAME" >> "$GITHUB_OUTPUT"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "is_manual=$IS_MANUAL" >> "$GITHUB_OUTPUT"

  update-aur:
    needs: get-info
    runs-on: ubuntu-latest
    steps:
      - name: Check AUR Status
        id: check
        run: |
          VERSION="${{ needs.get-info.outputs.version }}"
          PKGNAME="${{ needs.get-info.outputs.pkgname }}"
          IS_MANUAL="${{ needs.get-info.outputs.is_manual }}"

          if [ "$IS_MANUAL" == "true" ]; then
             echo "should_skip=false" >> "$GITHUB_OUTPUT"
             echo "Manual update requested."
          else
             AUR_VERSION=$(curl -s "https://aur.archlinux.org/rpc/v5/info/$PKGNAME" | jq -r '.results[0].Version // empty' | cut -d'-' -f1)
             echo "AUR Current Version: $AUR_VERSION"
             
             if [ "$AUR_VERSION" == "$VERSION" ]; then
               echo "should_skip=true" >> "$GITHUB_OUTPUT"
               echo "Reason: Version $VERSION already in AUR."
             else
               echo "should_skip=false" >> "$GITHUB_OUTPUT"
             fi
          fi

      - name: Checkout repository
        if: steps.check.outputs.should_skip != 'true'
        uses: actions/checkout@v4

      - name: Update PKGBUILD and Checksums
        if: steps.check.outputs.should_skip != 'true'
        run: |
          docker run --rm \
            -v "$PWD:/src" \
            -w /src \
            -e VERSION="${{ needs.get-info.outputs.version }}" \
            -e IS_MANUAL="${{ needs.get-info.outputs.is_manual }}" \
            archlinux:base-devel sh -c '
              pacman -Sy --noconfirm pacman-contrib mise

              # Update PKGBUILD
              if [ "$IS_MANUAL" == "false" ]; then
                sed -i "s/^pkgver=.*$/pkgver=$VERSION/" PKGBUILD
                sed -i "s/^pkgrel=.*$/pkgrel=1/" PKGBUILD
              fi

              updpkgsums
              sudo -u nobody makepkg --printsrcinfo > .SRCINFO
              chown -R 1001:121 .
            '

      - name: Publish to AUR
        if: steps.check.outputs.should_skip != 'true'
        uses: KSXGitHub/github-actions-deploy-aur@v2.2.5
        with:
          pkgname: ${{ needs.get-info.outputs.pkgname }}
          pkgbuild: ./PKGBUILD
          commit_username: ${{ secrets.AUR_USERNAME }}
          commit_email: ${{ secrets.AUR_EMAIL }}
          ssh_private_key: ${{ secrets.AUR_SSH_PRIVATE_KEY }}
          commit_message: "Update to ${{ needs.get-info.outputs.version }}"
          ssh_keyscan_types: rsa,ecdsa,ed25519

      - name: Trigger MyRepo Build
        if: success()
        uses: peter-evans/repository-dispatch@v4
        with:
          token: ${{ secrets.REPO_ACCESS_TOKEN }}
          repository: mydehq/my-repo
          event-type: trigger-build

  update-winget:
    needs: get-info
    runs-on: windows-latest
    steps:
      - name: Publish to Winget
        id: winget-release
        uses: vedantmgoyal2009/winget-releaser@v2
        with:
          identifier: ${{ github.repository_owner }}.${{ needs.get-info.outputs.pkgname }}
          version: ${{ needs.get-info.outputs.version }}
          release-tag: v${{ needs.get-info.outputs.version }}
          installers-regex: '${{ needs.get-info.outputs.pkgname }}-windows-amd64\.exe$'
          max-versions-to-keep: 4
          token: ${{ secrets.WINGET_TOKEN }}

      - name: Patch PackageDependencies into manifest
        env:
          GITHUB_TOKEN: ${{ secrets.WINGET_TOKEN }}
          PKG_ID: ${{ github.repository_owner }}.${{ needs.get-info.outputs.pkgname }}
          VERSION: ${{ needs.get-info.outputs.version }}
          FORK_OWNER: ${{ github.repository_owner }}
        shell: pwsh
        run: |
          $PathSegment = $env:PKG_ID.Replace('.', '/')
          $ManifestPath = "manifests/$($env:PKG_ID.ToLower()[0])/$PathSegment/$env:VERSION/$env:PKG_ID.installer.yaml"
          $Headers = @{ Authorization = "token $env:GITHUB_TOKEN"; Accept = "application/vnd.github.v3+json" }

          # Find the branch komac pushed — it's named <PkgId>-<Version>-<random hash>
          $BranchPrefix = "$env:PKG_ID-$env:VERSION-"
          $BranchesUrl = "https://api.github.com/repos/$env:FORK_OWNER/winget-pkgs/branches?per_page=100"
          $Branches = Invoke-RestMethod -Uri $BranchesUrl -Headers $Headers
          $Branch = ($Branches | Where-Object { $_.name -like "$BranchPrefix*" } | Select-Object -First 1).name

          if (-not $Branch) {
            Write-Output "No branch matching '$BranchPrefix*' found — skipping dependency patch."
            exit 0
          }
          Write-Output "Found branch: $Branch"

          # Fetch manifest file + SHA from fork branch
          $ApiBase = "https://api.github.com/repos/$env:FORK_OWNER/winget-pkgs/contents/$ManifestPath"
          try {
            $File = Invoke-RestMethod -Uri "$ApiBase`?ref=$Branch" -Headers $Headers
          } catch {
            Write-Output "Manifest not found at $ManifestPath — skipping."
            exit 0
          }

          $Content = [System.Text.Encoding]::UTF8.GetString([System.Convert]::FromBase64String($File.content))

          # Idempotent — skip if already patched
          if ($Content -match 'PackageDependencies') {
            Write-Output "Dependencies already present — skipping."
            exit 0
          }

          $DepsBlock = "Dependencies:`n  PackageDependencies:`n    - PackageIdentifier: MoritzBunkus.MKVToolNix`n    - PackageIdentifier: wez.AtomicParsley"

          # Insert before ManifestType line
          $Patched = $Content -replace '(ManifestType: installer)', "$DepsBlock`n`$1"

          $Encoded = [System.Convert]::ToBase64String([System.Text.Encoding]::UTF8.GetBytes($Patched))
          $Body = @{
            message = "chore: add PackageDependencies for $env:PKG_ID $env:VERSION"
            content = $Encoded
            sha     = $File.sha
            branch  = $Branch
          } | ConvertTo-Json

          Invoke-RestMethod -Method Put -Uri $ApiBase -Headers $Headers -Body $Body -ContentType "application/json"
          Write-Output "✓ PackageDependencies patched into $ManifestPath on branch $Branch"
