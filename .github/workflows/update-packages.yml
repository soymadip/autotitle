name: Update Distribution Packages
run-name: "Update Distribution Packages: (${{ github.event_name == 'workflow_run' && 'Release' || 'Manual Fix' }})"

on:
  workflow_run:
    workflows: ["Make GitHub Release"]
    types:
      - completed

  push:
    branches: [main]
    paths:
      - "PKGBUILD"
      - ".github/workflows/update-packages.yml"

  workflow_dispatch:
    inputs:
      version:
        description: "Version to publish (e.g., 1.4.0)"
        required: false
        type: string

concurrency:
  group: update-dist-packages
  cancel-in-progress: true

permissions:
  contents: write
  pull-requests: write

jobs:
  get-info:
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success') ||
      (github.event_name == 'push' && !startsWith(github.event.head_commit.message, 'chore(release):')) ||
      (github.event_name == 'workflow_dispatch')

    outputs:
      version: ${{ steps.resolve-meta.outputs.version }}
      is_manual: ${{ steps.resolve-meta.outputs.is_manual }}
      pkgname: ${{ steps.resolve-meta.outputs.pkgname }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Resolve metadata
        id: resolve-meta
        run: |
          # Get package name from repository name (lowercase)
          PKGNAME=$(echo "${{ github.event.repository.name }}" | tr '[:upper:]' '[:lower:]')

          # Workflow run
          if [ "${{ github.event_name }}" == "workflow_run" ]; then
            RAW_TAG="${{ github.event.workflow_run.head_branch }}"
            if [[ "$RAW_TAG" == "main" || -z "$RAW_TAG" ]]; then
              RAW_TAG=$(git describe --tags --abbrev=0)
            fi

            VERSION="${RAW_TAG#v}"
            IS_MANUAL="false"

          # Workflow dispatch with version input 
          elif [ "${{ github.event_name }}" == "workflow_dispatch" ] && [ -n "${{ github.event.inputs.version }}" ]; then
            VERSION="${{ github.event.inputs.version }}"
            IS_MANUAL="true"

          # Push or manual without version input: Read from file
          else
            VERSION=$(sed -n 's/^pkgver=//p' PKGBUILD | tr -d '"' | tr -d "'")
            IS_MANUAL="true"
          fi

          echo "Package Name:     $PKGNAME"
          echo "Detected Version: $VERSION"
          echo "Is Manual Update: $IS_MANUAL"

          # Output core variables
          echo "pkgname=$PKGNAME" >> "$GITHUB_OUTPUT"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "is_manual=$IS_MANUAL" >> "$GITHUB_OUTPUT"

  update-aur:
    needs: get-info
    runs-on: ubuntu-latest
    steps:
      - name: Check AUR Status
        id: check
        run: |
          VERSION="${{ needs.get-info.outputs.version }}"
          PKGNAME="${{ needs.get-info.outputs.pkgname }}"
          IS_MANUAL="${{ needs.get-info.outputs.is_manual }}"

          if [ "$IS_MANUAL" == "true" ]; then
             echo "should_skip=false" >> "$GITHUB_OUTPUT"
             echo "Manual update requested."
          else
             AUR_VERSION=$(curl -s "https://aur.archlinux.org/rpc/v5/info/$PKGNAME" | jq -r '.results[0].Version // empty' | cut -d'-' -f1)
             echo "AUR Current Version: $AUR_VERSION"
             
             if [ "$AUR_VERSION" == "$VERSION" ]; then
               echo "should_skip=true" >> "$GITHUB_OUTPUT"
               echo "Reason: Version $VERSION already in AUR."
             else
               echo "should_skip=false" >> "$GITHUB_OUTPUT"
             fi
          fi

      - name: Checkout repository
        if: steps.check.outputs.should_skip != 'true'
        uses: actions/checkout@v4

      - name: Update PKGBUILD and Checksums
        if: steps.check.outputs.should_skip != 'true'
        run: |
          docker run --rm \
            -v "$PWD:/src" \
            -w /src \
            -e VERSION="${{ needs.get-info.outputs.version }}" \
            -e IS_MANUAL="${{ needs.get-info.outputs.is_manual }}" \
            archlinux:base-devel sh -c '
              pacman -Sy --noconfirm pacman-contrib mise

              # Update PKGBUILD
              if [ "$IS_MANUAL" == "false" ]; then
                sed -i "s/^pkgver=.*$/pkgver=$VERSION/" PKGBUILD
                sed -i "s/^pkgrel=.*$/pkgrel=1/" PKGBUILD
              fi

              updpkgsums
              sudo -u nobody makepkg --printsrcinfo > .SRCINFO
              chown -R 1001:121 .
            '

      - name: Publish to AUR
        if: steps.check.outputs.should_skip != 'true'
        uses: KSXGitHub/github-actions-deploy-aur@v2.2.5
        with:
          pkgname: ${{ needs.get-info.outputs.pkgname }}
          pkgbuild: ./PKGBUILD
          commit_username: ${{ secrets.AUR_USERNAME }}
          commit_email: ${{ secrets.AUR_EMAIL }}
          ssh_private_key: ${{ secrets.AUR_SSH_PRIVATE_KEY }}
          commit_message: "Update to ${{ needs.get-info.outputs.version }}"
          ssh_keyscan_types: rsa,ecdsa,ed25519

      - name: Trigger MyRepo Build
        if: success()
        uses: peter-evans/repository-dispatch@v4
        with:
          token: ${{ secrets.REPO_ACCESS_TOKEN }}
          repository: mydehq/my-repo
          event-type: trigger-build

  update-winget:
    needs: get-info
    runs-on: ubuntu-latest
    steps:
      - name: Publish to Winget
        id: winget-release
        uses: vedantmgoyal2009/winget-releaser@v2
        with:
          identifier: ${{ github.repository_owner }}.${{ needs.get-info.outputs.pkgname }}
          version: ${{ needs.get-info.outputs.version }}
          release-tag: v${{ needs.get-info.outputs.version }}
          installers-regex: '${{ needs.get-info.outputs.pkgname }}-windows-amd64\.exe$'
          max-versions-to-keep: 4
          token: ${{ secrets.WINGET_TOKEN }}

      - name: Patch PackageDependencies into manifest
        env:
          GITHUB_TOKEN: ${{ secrets.WINGET_TOKEN }}
          PKG_ID: ${{ github.repository_owner }}.${{ needs.get-info.outputs.pkgname }}
          VERSION: ${{ needs.get-info.outputs.version }}
          FORK_OWNER: ${{ github.repository_owner }}
        run: |
          # Resolve manifest path
          PATH_SEGMENT=$(echo "$PKG_ID" | tr '.' '/')
          FIRST_CHAR=$(echo "${PKG_ID:0:1}" | tr '[:upper:]' '[:lower:]')
          MANIFEST_PATH="manifests/$FIRST_CHAR/$PATH_SEGMENT/$VERSION/$PKG_ID.installer.yaml"

          echo "Target Manifest: $MANIFEST_PATH"

          # Find branch
          BRANCH=$(curl -s -H "Authorization: token $GITHUB_TOKEN" "https://api.github.com/repos/$FORK_OWNER/winget-pkgs/branches?per_page=100" | jq -r ".[] | select(.name | startswith(\"$PKG_ID-$VERSION-\")) | .name" | head -n 1)

          if [ -z "$BRANCH" ] || [ "$BRANCH" == "null" ]; then
            echo "No branch matching '$PKG_ID-$VERSION-*' found â€” skipping patch."
            exit 0
          fi

          # Fetch manifest
          API_URL="https://api.github.com/repos/$FORK_OWNER/winget-pkgs/contents/$MANIFEST_PATH?ref=$BRANCH"
          FILE_DATA=$(curl -s -H "Authorization: token $GITHUB_TOKEN" "$API_URL")
          if ! echo "$FILE_DATA" | jq -e '.content' > /dev/null; then
            echo "Manifest not found â€” skipping."
            exit 0
          fi

          CONTENT=$(echo "$FILE_DATA" | jq -r '.content' | tr -d '\n\r' | base64 -d)
          SHA=$(echo "$FILE_DATA" | jq -r '.sha')

          if [[ "$CONTENT" == *"PackageDependencies"* ]]; then
            echo "Already patched â€” skipping."
            exit 0
          fi

          # Patch with yq and force CRLF line endings
          PATCHED=$(echo "$CONTENT" | yq '.Dependencies.PackageDependencies = [
            {"PackageIdentifier": "MoritzBunkus.MKVToolNix"},
            {"PackageIdentifier": "wez.AtomicParsley"}
          ]' - | sed 's/$/\r/')

          ENCODED=$(echo "$PATCHED" | base64 -w 0)
          BODY=$(jq -n --arg msg "chore: add PackageDependencies for $PKG_ID $VERSION" --arg content "$ENCODED" --arg sha "$SHA" --arg branch "$BRANCH" '{message: $msg, content: $content, sha: $sha, branch: $branch}')

          curl -X PUT -s -H "Authorization: token $GITHUB_TOKEN" -H "Content-Type: application/json" -d "$BODY" "$API_URL"
          echo "âœ“ Manifest structurally patched & CRLF forced"

          # Find and print Winget PR URL to GitHub Summary
          UPSTREAM_PR=$(curl -s -H "Authorization: token $GITHUB_TOKEN" "https://api.github.com/repos/microsoft/winget-pkgs/pulls?head=$FORK_OWNER:$BRANCH&state=open" | jq -r ".[0].html_url")
          if [ "$UPSTREAM_PR" != "null" ] && [ -n "$UPSTREAM_PR" ]; then
            echo "### ðŸ“¦ Winget Submission" >> $GITHUB_STEP_SUMMARY
            echo "Successfully patched and submitted version **$VERSION** to Winget." >> $GITHUB_STEP_SUMMARY
            echo "- **Pull Request**: $UPSTREAM_PR" >> $GITHUB_STEP_SUMMARY
          fi
